import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormControl, FormGroup, Validators } from '@angular/forms';
import { DepartamentoService, Departamento } from '../services/departamento.service';
import { CursoService, Curso, UpdateCursoRequest, CreateCursoRequest } from '../services/cursos.service';
import { ProfessorService, Professor } from '../services/professor.service';

@Component({
  selector: 'app-curso',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './curso.component.html',
  styleUrls: ['./curso.component.css']
})
export class CursoComponent {

  mostrarFormulario = false;
  idEmEdicao: number | null = null;
  listaDepartamentos: Departamento[] = [];
  listaProfessores: Professor[] = [];
  professorSelecionados: number[] = [];

  formulario = new FormGroup({
    nome: new FormControl('', Validators.required),
    cargaHoraria: new FormControl('', Validators.required),
    departamentos_idDepartamentos: new FormControl<number | null>(null, [Validators.required, Validators.min(1)]),
    professores: new FormControl<number[]>([])
  });

  listaCursos: Curso[] = [];

  constructor(
    private departamentoService: DepartamentoService,
    private cursoService: CursoService,
    private professorService: ProfessorService
  ) {
    this.listaDepartamentos = this.departamentoService.getDepartamentos();
  }

  ngOnInit() {
    this.carregarCursos();
    this.carregarProfessores();
  }

  carregarProfessores() {
    this.professorService.listar().subscribe({
      next: (dados) => {
        this.listaProfessores = dados;
      },
      error: (erro) => {
        console.error('Erro ao carregar professores', erro);
      }
    });
  }

  carregarCursos() {
    this.cursoService.listar().subscribe({
      next: (dados) => {
        this.listaCursos = dados;
      },
      error: (erro) => {
        console.error('Erro ao carregar cursos', erro);
      }
    });
  }

  salvar() {
    if (this.formulario.valid) {
      const dados = this.formulario.value;
      const departamentoId = Number(dados.departamentos_idDepartamentos);
      const professorIds = this.professorSelecionados.map(p => Number(p));

      if (this.idEmEdicao) {
        // UPDATE
        const updateRequest: UpdateCursoRequest = {
          idCursos: this.idEmEdicao,
          nome: dados.nome || '',
          cargaHoraria: dados.cargaHoraria || '',
          departamentos_idDepartamentos: departamentoId,
          professores: professorIds
        };

        console.log('=== ATUALIZANDO CURSO ===');
        console.log('Request para enviar:', updateRequest);
        console.log('Tipos dos professores:', professorIds.map(p => typeof p));

        this.cursoService.atualizar(updateRequest).subscribe({
          next: () => {
            this.carregarCursos();
            this.mostrarFormulario = false;
            this.idEmEdicao = null;
            alert('Curso atualizado com sucesso!');
          },
          error: (erro) => {
            console.error('Erro ao atualizar curso', erro);
            console.error('Detalhes do erro:', erro.error);
            console.error('Status da resposta:', erro.status);
            console.error('URL da requisição:', erro.url);

            let mensagemErro = 'Erro desconhecido ao atualizar curso';

            if (erro.status === 500) {
              console.error('Erro 500 - Resposta completa do servidor:', erro);
              if (erro.error) {
                mensagemErro = `Erro no servidor: ${JSON.stringify(erro.error)}`;
              } else {
                mensagemErro = 'Erro interno no servidor (500). Verifique os logs do backend.';
              }
            } else if (erro.status === 400) {
              mensagemErro = 'Dados inválidos. Verifique os campos do formulário.';
            } else if (erro.error?.message) {
              mensagemErro = erro.error.message;
            } else if (erro.message) {
              mensagemErro = erro.message;
            }

            alert('Erro ao atualizar curso: ' + mensagemErro);
          }
        });
      } else {
        // CREATE
        const createRequest: CreateCursoRequest = {
          nome: dados.nome || '',
          cargaHoraria: dados.cargaHoraria || '',
          departamentos_idDepartamentos: departamentoId,
          professores: professorIds
        };

        console.log('=== CRIANDO CURSO ===');
        console.log('Request para enviar:', createRequest);
        console.log('Tipos dos professores:', professorIds.map(p => typeof p));

        this.cursoService.criar(createRequest).subscribe({
          next: () => {
            this.carregarCursos();
            this.mostrarFormulario = false;
            alert('Curso criado com sucesso!');
          },
          error: (erro) => {
            console.error('Erro ao criar curso', erro);
            console.error('Detalhes do erro:', erro.error);
            console.error('Status da resposta:', erro.status);
            console.error('URL da requisição:', erro.url);

            let mensagemErro = 'Erro desconhecido ao criar curso';

            if (erro.status === 500) {
              console.error('Erro 500 - Resposta completa do servidor:', erro);
              if (erro.error) {
                mensagemErro = `Erro no servidor: ${JSON.stringify(erro.error)}`;
              } else {
                mensagemErro = 'Erro interno no servidor (500). Verifique os logs do backend.';
              }
            } else if (erro.status === 400) {
              mensagemErro = 'Dados inválidos. Verifique os campos do formulário.';
            } else if (erro.error?.message) {
              mensagemErro = erro.error.message;
            } else if (erro.message) {
              mensagemErro = erro.message;
            }

            alert('Erro ao criar curso: ' + mensagemErro);
          }
        });
      }
    } else {
      console.log('Formulário inválido:', this.formulario.errors);
      alert('Por favor, preencha todos os campos obrigatórios.');
    }
  }

  deletar(id: number) {
    if (confirm('Deseja excluir?')) {
      this.cursoService.deletar(id).subscribe({
        next: () => {
          this.carregarCursos();
          alert('Curso deletado com sucesso!');
        },
        error: (erro) => {
          console.error('Erro ao deletar curso', erro);
          let mensagemErro = 'Erro desconhecido ao deletar curso';

          if (erro.status === 500) {
            mensagemErro = 'Não é possível deletar este curso pois ele está vinculado a alunos, professores ou outras entidades. Remova os vínculos primeiro.';
          } else if (erro.error?.message) {
            mensagemErro = erro.error.message;
          } else if (erro.message) {
            mensagemErro = erro.message;
          }

          alert('Erro ao deletar curso: ' + mensagemErro);
        }
      });
    }
  }

  getNomeDepartamento(id: number): string {
    return this.departamentoService.getNomeDepartamento(id);
  }

  abrirFormulario() {
    this.mostrarFormulario = true;
    this.idEmEdicao = null;
    this.formulario.reset();
    this.professorSelecionados = [];
  }

  edita(curso: Curso) {
    console.log('=== EDITANDO CURSO ===');
    console.log('Curso selecionado:', curso);

    this.mostrarFormulario = true;
    this.idEmEdicao = curso.idCursos;
    this.professorSelecionados = curso.professores || [];

    this.formulario.setValue({
      nome: curso.nome,
      cargaHoraria: curso.cargaHoraria,
      departamentos_idDepartamentos: curso.departamentos_idDepartamentos,
      professores: curso.professores || []
    });

    console.log('Valores no formulário após carregar:', this.formulario.value);
    console.log('Formulário válido?', this.formulario.valid);
  }

  toggleProfessor(professorId: number) {
    const index = this.professorSelecionados.indexOf(professorId);
    if (index > -1) {
      this.professorSelecionados.splice(index, 1);
    } else {
      this.professorSelecionados.push(professorId);
    }
    console.log('Professores selecionados:', this.professorSelecionados);
  }

  isProfessorSelecionado(professorId: number): boolean {
    return this.professorSelecionados.includes(professorId);
  }

  getNomeProfessores(ids?: number[]): string {
    if (!ids || ids.length === 0) {
      return 'Nenhum professor';
    }
    const nomes = ids
      .map(id => this.listaProfessores.find(p => p.idProfessores === id)?.nome)
      .filter(nome => nome)
      .join(', ');
    return nomes || 'Nenhum professor';
  }

  cancelar() {
    this.mostrarFormulario = false;
    this.idEmEdicao = null;
    this.professorSelecionados = [];
  }
}
